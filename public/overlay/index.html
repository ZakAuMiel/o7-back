<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Overlay</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Rubik:wght@500;700&display=swap"
      rel="stylesheet"
    />

    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        background: transparent;
        overflow: hidden;
        width: 100vw;
        height: 100vh;
      }

      /* La sc√®ne = tout l'√©cran (Melted / OBS) */
      #container {
        position: relative;
        width: 100vw;
        height: 100vh;
        opacity: 0;
        background: rgba(0, 0, 0, 0);
        padding: 0;
        color: white;
        font-family: "Rubik", sans-serif;
        overflow: hidden;
      }

      #user-info {
        display: flex;
        align-items: center;
        gap: 10px;
        pointer-events: none;
      }

      #avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        border: 2px solid white;
        object-fit: cover;
      }

      #username {
        font-weight: bold;
        font-size: 1.2rem;
        white-space: nowrap;
      }

      .wave-username {
        animation: wave 0.6s ease-in-out;
      }

      @keyframes wave {
        0% {
          transform: scale(1) rotate(0deg);
        }
        15% {
          transform: scale(1.15, 0.85) rotate(-2deg);
        }
        30% {
          transform: scale(0.95, 1.05) rotate(2deg);
        }
        45% {
          transform: scale(1.05, 0.95) rotate(-1deg);
        }
        60% {
          transform: scale(1) rotate(0deg);
        }
        100% {
          transform: scale(1) rotate(0deg);
        }
      }

      /* Fichiers locaux (vid√©o / image) dans le wrapper */
      video,
      img {
        width: 100%;
        height: 100%;
        border-radius: 10px;
        background: black;
        border: none;
        object-fit: contain;
      }

      /* Iframes (YouTube / Twitch / TikTok Player) remplissent juste le wrapper */
      iframe {
        width: 100%;
        height: 100%;
        border-radius: 10px;
        border: none;
      }

      #media-wrapper {
        pointer-events: none;
      }

      #message {
        font-size: 1rem;
        color: #f7e6e6;
        text-align: center;
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <div id="container">
      <div id="user-info">
        <img id="avatar" src="" alt="avatar" />
        <div id="username">Pseudo</div>
      </div>
      <div id="media-wrapper"></div>
      <div id="message"></div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <script>
      const socket = io(location.origin, { transports: ["websocket"] });

      const container = document.getElementById("container");
      const userInfo = document.getElementById("user-info");
      const avatar = document.getElementById("avatar");
      const username = document.getElementById("username");
      const wrapper = document.getElementById("media-wrapper");
      const message = document.getElementById("message");

      function resetOverlay() {
        wrapper.innerHTML = "";
        avatar.src = "";
        username.textContent = "";
        username.classList.remove("wave-username");
        message.textContent = "";

        container.style.opacity = 0;
        container.style.display = "none";

        userInfo.style.position = "";
        userInfo.style.left = "";
        userInfo.style.top = "";
        userInfo.style.width = "";
        userInfo.style.height = "";
        userInfo.style.transform = "";

        wrapper.style.position = "";
        wrapper.style.left = "";
        wrapper.style.top = "";
        wrapper.style.width = "";
        wrapper.style.height = "";

        message.style.position = "";
        message.style.left = "";
        message.style.top = "";
        message.style.width = "";
        message.style.height = "";
      }

      function hideOverlay() {
        gsap.to(container, {
          opacity: 0,
          duration: 0.5,
          onComplete: resetOverlay,
        });
      }

      // Helpers YouTube / Twitch / TikTok Player
      function getYouTubeEmbed(url) {
        const match = url.match(
          /(?:youtube\.com\/.*v=|youtu\.be\/)([^&#?/]+)/i
        );
        const videoId = match ? match[1] : null;
        if (!videoId) return null;

        // YouTube en 16:9 dans le wrapper, contr√¥les masqu√©s, autoplay
        return `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=0&controls=0&playsinline=1`;
      }

      function getTwitchEmbed(url) {
        const lower = url.toLowerCase();
        const host = location.hostname || "localhost";

        const vodMatch = lower.match(/twitch\.tv\/videos\/(\d+)/);
        if (vodMatch) {
          const videoId = vodMatch[1];
          return `https://player.twitch.tv/?video=${videoId}&parent=${host}&autoplay=true&muted=false`;
        }

        const channelMatch = lower.match(/twitch\.tv\/([a-z0-9_]+)(?:\/)?$/);
        if (channelMatch) {
          const channel = channelMatch[1];
          return `https://player.twitch.tv/?channel=${channel}&parent=${host}&autoplay=true&muted=false`;
        }

        return null;
      }

      function getTikTokVideoId(url) {
        const match = url.match(/tiktok\.com\/.*video\/(\d+)/i);
        return match ? match[1] : null;
      }

      function getTikTokPlayerUrl(url) {
        const id = getTikTokVideoId(url);
        if (!id) return null;

        // TikTok Embed Player v1
        // param√®tres d'UI depuis la doc officielle
        const params = new URLSearchParams({
          controls: "0", // hide progress bar + control buttons
          progress_bar: "0",
          play_button: "0",
          volume_control: "0",
          fullscreen_button: "0",
          timestamp: "0",
          loop: "0", // ne pas boucler
          autoplay: "1", // auto play
          music_info: "0",
          description: "0",
          rel: "0",
          native_context_menu: "0",
          closed_caption: "0",
          cookie_consent: "0",
          gdpr: "0",
          tos: "0",
        });

        return `https://www.tiktok.com/player/v1/${id}?${params.toString()}`;
      }

      function applyLayout(layout) {
        container.style.display = "block";

        if (layout && layout.userInfo) {
          userInfo.style.position = "absolute";
          userInfo.style.left = layout.userInfo.x + "%";
          userInfo.style.top = layout.userInfo.y + "%";
          userInfo.style.width = layout.userInfo.width + "%";
          userInfo.style.height = layout.userInfo.height + "%";
          userInfo.style.transform = "translate(0, 0)";
        }

        if (layout && layout.media) {
          wrapper.style.position = "absolute";
          wrapper.style.left = layout.media.x + "%";
          wrapper.style.top = layout.media.y + "%";
          wrapper.style.width = layout.media.width + "%";
          wrapper.style.height = layout.media.height + "%";
        }

        if (layout && layout.message) {
          message.style.position = "absolute";
          message.style.left = layout.message.x + "%";
          message.style.top = layout.message.y + "%";
          message.style.width = layout.message.width + "%";
          message.style.height = layout.message.height + "%";
        }
      }

      socket.on("new-media", (data) => {
        resetOverlay();

        username.textContent = data.username || "Anonyme";
        username.classList.remove("wave-username");
        void username.offsetWidth;
        username.classList.add("wave-username");

        avatar.src = data.avatarUrl || "";

        const layout = data.layout || null;

        const rawUrl = data.url || "";
        const mediaUrl =
          rawUrl.startsWith("http://") || rawUrl.startsWith("https://")
            ? rawUrl
            : location.origin + rawUrl;

        const isAudio = data.type === "audio";
        const isYouTube = data.type === "youtube";
        const isTikTokPlayer = data.type === "tiktok-player";
        const isTwitch = data.type === "twitch";
        const isEmbed = isYouTube || isTikTokPlayer || isTwitch;

        // üéµ AUDIO
        if (isAudio) {
          container.style.display = "block";
          wrapper.innerHTML = "";

          const audio = document.createElement("audio");
          audio.src = mediaUrl;
          audio.autoplay = true;
          audio.controls = false;
          audio.volume = 1;
          audio.muted = false;
          audio.setAttribute("crossorigin", "anonymous");

          wrapper.appendChild(audio);

          audio.oncanplay = () => {
            audio
              .play()
              .then(() => console.log("üéµ Audio lanc√©"))
              .catch((err) => console.warn("Erreur lecture audio :", err));
          };

          applyLayout(layout);

          gsap.fromTo(
            container,
            { opacity: 0, scale: 0.95 },
            { opacity: 1, scale: 1, duration: 0.5 }
          );

          const customDuration =
            data.duration &&
            !isNaN(Number(data.duration)) &&
            Number(data.duration) > 0
              ? Number(data.duration)
              : null;

          if (customDuration) {
            setTimeout(() => {
              audio.pause();
              audio.remove();
              hideOverlay();
            }, customDuration);
          } else {
            audio.addEventListener("ended", () => {
              audio.pause();
              audio.remove();
              hideOverlay();
            });

            setTimeout(() => {
              if (!audio.paused) {
                audio.pause();
                audio.remove();
                hideOverlay();
              }
            }, 5 * 60 * 1000);
          }

          return;
        }

        // üé¨ EMBEDS (YouTube / TikTok Player / Twitch)
        if (isEmbed) {
          container.style.display = "block";
          wrapper.innerHTML = "";

          let iframeSrc = null;

          if (isTikTokPlayer) {
            iframeSrc = getTikTokPlayerUrl(mediaUrl);
          } else if (isYouTube) {
            iframeSrc = getYouTubeEmbed(mediaUrl);
          } else if (isTwitch) {
            iframeSrc = getTwitchEmbed(mediaUrl);
          }

          if (!iframeSrc) {
            iframeSrc = mediaUrl;
          }

          const iframe = document.createElement("iframe");
          iframe.src = iframeSrc;
          iframe.allow =
            "autoplay; encrypted-media; picture-in-picture; fullscreen";
          iframe.allowFullscreen = true;

          wrapper.appendChild(iframe);

          if (data.message) {
            message.textContent = data.message;
          }

          applyLayout(layout);

          gsap.fromTo(
            container,
            { opacity: 0, scale: 0.95 },
            { opacity: 1, scale: 1, duration: 0.5 }
          );

          const customDuration =
            data.duration &&
            !isNaN(Number(data.duration)) &&
            Number(data.duration) > 0
              ? Number(data.duration)
              : 10000; // 10s par d√©faut

          setTimeout(() => {
            hideOverlay();
          }, customDuration);

          return;
        }

        // üé• / üñºÔ∏è VIDEO / IMAGE fichiers locaux
        const media = document.createElement(
          data.type === "video" ? "video" : "img"
        );
        media.src = mediaUrl;

        if (data.type === "video") {
          media.autoplay = true;
          media.playsInline = true;
          media.controls = false;
          media.muted = false;
          media.volume = 1;
          media.setAttribute("crossorigin", "anonymous");

          media.oncanplay = () => {
            media
              .play()
              .catch((err) => console.warn("Erreur lecture vid√©o :", err));
          };
        }

        wrapper.innerHTML = "";
        wrapper.appendChild(media);

        if (data.message) {
          message.textContent = data.message;
        }

        applyLayout(layout);

        container.style.display = "block";

        gsap.fromTo(
          container,
          { opacity: 0, scale: 0.95 },
          { opacity: 1, duration: 0.5 }
        );

        const durationVal =
          !isNaN(Number(data.duration)) && Number(data.duration) > 0
            ? Number(data.duration)
            : data.type === "image"
            ? 5000
            : null;

        if (durationVal) {
          setTimeout(() => {
            if (media.tagName === "VIDEO") {
              media.pause();
              media.removeAttribute("src");
              media.load();
            }
            hideOverlay();
          }, durationVal);
        } else if (data.type === "video") {
          media.onended = () => hideOverlay();
        }
      });

      socket.on("shutdown-overlay", hideOverlay);
    </script>
  </body>
</html>

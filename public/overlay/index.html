<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Overlay</title>
    <!-- Font Rubik -->
    <link
      href="https://fonts.googleapis.com/css2?family=Rubik:wght@500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        background: transparent;
        overflow: hidden;
        width: 100vw;
        height: 100vh;
        font-family: "Rubik", sans-serif;
      }

      #container {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.8);
        opacity: 0;
        background: rgba(0, 0, 0, 0.85);
        padding: 20px;
        border-radius: 12px;
        color: white;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        max-width: 90vw;
      }

      #user-info {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      #avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        border: 2px solid white;
        object-fit: cover;
        transition: box-shadow 0.3s ease;
      }

      #avatar.glow {
        box-shadow: 0 0 20px rgba(0, 255, 120, 0.8);
      }

      #username {
        font-weight: 700;
        font-size: 1.4rem;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
      }

      video,
      img,
      #audio-icon {
        max-width: 80vw;
        max-height: 60vh;
        border-radius: 10px;
        background: black;
      }

      #audio-icon {
        width: 120px;
        height: 120px;
        object-fit: contain;
      }

      #message {
        font-size: 1.2rem;
        font-weight: 500;
        color: #f7e6e6;
        text-align: center;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
      }

      #progress-bar {
        width: 100%;
        height: 6px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
        overflow: hidden;
      }

      #progress-fill {
        height: 100%;
        width: 0%;
        background: linear-gradient(to right, #00ff99, #00ccff);
      }

      /* Audio mode */
      .audio-mode #container {
        position: fixed !important;
        top: 20px;
        right: 20px;
        transform: none !important;
        background: rgba(0, 0, 0, 0.85);
        padding: 12px 16px;
        gap: 8px;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0, 255, 120, 0.2);
        flex-direction: column;
        align-items: flex-end;
        max-width: 250px;
      }
    </style>
  </head>

  <body>
    <div id="container" style="display: none">
      <div id="user-info">
        <img id="avatar" src="" alt="avatar" />
        <div id="username">Pseudo</div>
      </div>
      <div id="media-wrapper"></div>
      <div id="message"></div>
      <div id="progress-bar"><div id="progress-fill"></div></div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script>
      const socket = io(location.origin, {
        transports: ["websocket"],
      });

      const container = document.getElementById("container");
      const wrapper = document.getElementById("media-wrapper");
      const usernameEl = document.getElementById("username");
      const avatarEl = document.getElementById("avatar");
      const messageEl = document.getElementById("message");
      const progressFill = document.getElementById("progress-fill");

      function resetOverlay() {
        wrapper.innerHTML = "";
        messageEl.textContent = "";
        avatarEl.src = "";
        usernameEl.textContent = "";
        container.style.display = "none";
        avatarEl.classList.remove("glow");
        progressFill.style.width = "0%";
        gsap.killTweensOf(progressFill);
        container.classList.remove("audio-mode");
      }

      function hideOverlay() {
        const tl = gsap.timeline({ onComplete: resetOverlay });

        tl.to("#message", { opacity: 0, y: 20, duration: 0.3 }, 0)
          .to("#username", { opacity: 0, x: -20, duration: 0.3 }, 0)
          .to("#avatar", { opacity: 0, scale: 0.8, duration: 0.3 }, 0)
          .to(wrapper, { opacity: 0, scale: 0.8, duration: 0.3 }, 0)
          .to(
            container,
            {
              opacity: 0,
              scale: 0.5,
              rotateZ: 5,
              duration: 0.4,
              ease: "power2.in",
            },
            0.1
          );
      }

      socket.on("new-media", (data) => {
        resetOverlay();

        usernameEl.textContent = data.username || "Anonyme";
        avatarEl.src = data.avatarUrl || "";
        messageEl.textContent = data.message || "";
        avatarEl.classList.add("glow");

        const mediaUrl = `${location.origin}${data.url}`;
        const duration =
          !isNaN(Number(data.duration)) && Number(data.duration) > 0
            ? Number(data.duration)
            : null;

        let mediaEl;

        if (data.type === "audio") {
          container.classList.add("audio-mode");

          const audio = document.createElement("audio");
          audio.src = mediaUrl;
          audio.autoplay = true;
          audio.controls = true;
          audio.volume = 1;
          audio.setAttribute("crossorigin", "anonymous");
          audio.style.width = "200px";
          audio.style.borderRadius = "8px";

          wrapper.appendChild(audio);
          mediaEl = audio;

          container.style.display = "flex";

          gsap.fromTo(
            container,
            { opacity: 0, y: -30 },
            { opacity: 1, y: 0, duration: 0.6, ease: "power2.out" }
          );

          const audioDuration = duration || 7000;
          gsap.to(progressFill, {
            width: "100%",
            duration: audioDuration / 1000,
            ease: "linear",
          });

          setTimeout(hideOverlay, audioDuration);
          return;
        }

        mediaEl = document.createElement(
          data.type === "video" ? "video" : "img"
        );
        mediaEl.src = mediaUrl;

        if (data.type === "video") {
          mediaEl.autoplay = true;
          mediaEl.playsInline = true;
          mediaEl.controls = false;
          mediaEl.muted = false;
          mediaEl.volume = 1;
          mediaEl.setAttribute("crossorigin", "anonymous");
          mediaEl.oncanplay = () => {
            mediaEl
              .play()
              .catch((err) => console.warn("Erreur lecture :", err));
          };
        }

        wrapper.appendChild(mediaEl);
        container.style.display = "flex";

        gsap.set([avatarEl, usernameEl, mediaEl, messageEl], { opacity: 0 });

        const tl = gsap.timeline();

        tl.fromTo(
          container,
          { opacity: 0, scale: 0.5, rotateZ: -10 },
          {
            opacity: 1,
            scale: 1,
            rotateZ: 0,
            duration: 0.5,
            ease: "back.out(1.7)",
          }
        )
          .fromTo(
            avatarEl,
            { opacity: 0, scale: 0.6 },
            { opacity: 1, scale: 1, duration: 0.3, ease: "back.out(1.5)" },
            "-=0.3"
          )
          .fromTo(
            usernameEl,
            { opacity: 0, x: -20 },
            { opacity: 1, x: 0, duration: 0.3, ease: "power2.out" },
            "-=0.2"
          )
          .fromTo(
            mediaEl,
            { opacity: 0, scale: 0.9 },
            { opacity: 1, scale: 1, duration: 0.4, ease: "power2.out" },
            "-=0.2"
          )
          .fromTo(
            messageEl,
            { opacity: 0, y: 20 },
            { opacity: 1, y: 0, duration: 0.4, ease: "back.out(1.7)" },
            "-=0.2"
          );

        if (duration) {
          gsap.to(progressFill, {
            width: "100%",
            duration: duration / 1000,
            ease: "linear",
          });

          setTimeout(() => {
            if (mediaEl.tagName === "VIDEO") {
              mediaEl.pause();
              mediaEl.removeAttribute("src");
              mediaEl.load();
            }
            hideOverlay();
          }, duration);
        } else if (data.type === "video") {
          mediaEl.onended = () => hideOverlay();
        }
      });

      socket.on("shutdown-overlay", () => {
        const media = wrapper.querySelector("video, audio");
        if (media) {
          media.pause();
          media.removeAttribute("src");
          media.load();
        }
        hideOverlay();
      });
    </script>
  </body>
</html>

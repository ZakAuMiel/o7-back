<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Overlay</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Rubik:wght@500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        background: transparent;
        overflow: hidden;
        width: 100vw;
        height: 100vh;
        font-family: "Rubik", sans-serif;
      }

      #container {
        position: absolute;
        display: none;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        z-index: 9999;
      }

      #container.audio-mode {
        top: 24px;
        right: 24px;
        left: auto;
        transform: none;
        align-items: flex-end;
      }

      #container:not(.audio-mode) {
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }

      .avatar-wrapper {
        transition: transform 0.4s ease;
      }

      .avatar-wrapper:hover {
        transform: rotate(10deg) scale(1.1);
        filter: drop-shadow(0 0 10px #aa557f);
      }

      #avatar {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid white;
      }

      #username {
        font-size: 3rem;
        color: white;
        text-shadow: -2px -2px 0 #aa557f, 2px -2px 0 #aa557f, -2px 2px 0 #aa557f,
          2px 2px 0 #aa557f;
      }

      #media-wrapper {
        max-width: 95vw;
        max-height: 80vh;
        border-radius: 10px;
        overflow: hidden;
      }

      #message {
        font-size: 3rem;
        color: white;
        text-shadow: -2px -2px 0 #aa557f, 2px -2px 0 #aa557f, -2px 2px 0 #aa557f,
          2px 2px 0 #aa557f;
        text-align: center;
        line-height: 1.2;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <div id="container">
      <div class="avatar-wrapper">
        <img id="avatar" src="" alt="avatar" />
      </div>
      <div id="username">Pseudo</div>
      <div id="media-wrapper"></div>
      <div id="message"></div>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script>
      const socket = io(location.origin, { transports: ["websocket"] });

      const container = document.getElementById("container");
      const avatar = document.getElementById("avatar");
      const username = document.getElementById("username");
      const wrapper = document.getElementById("media-wrapper");
      const message = document.getElementById("message");

      function resetOverlay() {
        wrapper.innerHTML = "";
        avatar.src = "";
        username.textContent = "";
        message.textContent = "";
        container.classList.remove("audio-mode");
        container.style.display = "none";
      }

      function hideOverlay() {
        gsap.to(container, {
          opacity: 0,
          duration: 0.5,
          onComplete: resetOverlay,
        });
      }

      socket.on("new-media", (data) => {
        resetOverlay();

        username.textContent = data.username || "Anonyme";
        avatar.src = data.avatarUrl || "";

        if (data.type === "audio") {
          container.classList.add("audio-mode");
        } else {
          container.classList.remove("audio-mode");
        }

        container.style.display = "flex";
        gsap.fromTo(container, { opacity: 0 }, { opacity: 1, duration: 0.4 });

        if (data.type === "audio") {
          return setTimeout(hideOverlay, 7000);
        }

        const media = document.createElement(
          data.type === "video" ? "video" : "img"
        );
        media.src = location.origin + data.url;
        if (data.type === "video") {
          media.autoplay = true;
          media.playsInline = true;
          media.controls = false;
          media.muted = false;
          media.volume = 1;
          media.onended = hideOverlay;
        } else {
          setTimeout(hideOverlay, data.duration || 5000);
        }

        wrapper.appendChild(media);

        if (data.message) {
          message.textContent = data.message;
        }
      });

      socket.on("shutdown-overlay", hideOverlay);
    </script>
  </body>
</html>
